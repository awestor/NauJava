<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á—ë—Ç—ã —Å–∏—Å—Ç–µ–º—ã</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/reports.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
</head>
<body>
<div th:replace="~{fragments/adminHeader :: header}"></div>

<main class="main-container">
    <div class="page-header">
        <h1 class="page-title">–û—Ç—á—ë—Ç—ã —Å–∏—Å—Ç–µ–º—ã</h1>
        <span class="admin-badge">ADMIN</span>
    </div>

    <!-- –ë–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
    <div class="report-creation-section">
        <div class="creation-card">
            <h2 class="section-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞</h2>

            <div class="date-inputs">
                <div class="date-input-group">
                    <label for="startDate" class="date-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="startDate" class="date-input"
                               th:value="${periodStart}">
                        <button type="button" class="date-btn" onclick="openCalendar('start')">üìÖ</button>
                    </div>
                </div>

                <div class="date-separator">‚Üí</div>

                <div class="date-input-group">
                    <label for="endDate" class="date-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="endDate" class="date-input"
                               th:value="${periodEnd}">
                        <button type="button" class="date-btn" onclick="openCalendar('end')">üìÖ</button>
                    </div>
                </div>
            </div>

            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div id="calendarModal" class="calendar-modal">
                <div class="calendar-header">
                    <h3 id="calendarTitle">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
                    <button type="button" class="btn-close" onclick="closeCalendar()">&times;</button>
                </div>
                <div class="calendar-body">
                    <div class="calendar-controls">
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">
                            ‚Üê
                        </button>
                        <span id="calendarMonth" class="calendar-month"></span>
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">
                            ‚Üí
                        </button>
                    </div>
                    <div id="calendarContainer" class="calendar-grid"></div>
                </div>
            </div>

            <div class="creation-info">
                <div class="info-item">
                    <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="info-text">
                        –û—Ç—á—ë—Ç –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
                    </span>
                </div>
                <div class="info-item" id="existingReportWarning" style="display: none;">
                    <span class="info-icon">‚ö†Ô∏è</span>
                    <span class="info-text">
                        –û—Ç—á—ë—Ç –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω
                    </span>
                </div>
            </div>

            <div class="creation-actions">
                <button type="button" class="btn btn-secondary" onclick="checkExistingReport()">
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á—ë—Ç–∞
                </button>
                <button type="button" class="btn btn-primary" onclick="createReport()" id="createReportBtn">
                    <span class="btn-icon">üìä</span>
                    –°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç
                </button>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="quick-actions-section">
        <h2 class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="actions-grid">
            <button type="button" class="action-card" onclick="showLatestReport()"><!-- –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –º–µ—Ç–æ–¥ -->
                <div class="action-icon">üìã</div>
                <div class="action-title">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á—ë—Ç</div>
                <div class="action-description">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç</div>
            </button>

            <button type="button" class="action-card" onclick="showAllReports()">
                <div class="action-icon">üìö</div>
                <div class="action-title">–í—Å–µ –æ—Ç—á—ë—Ç—ã</div>
                <div class="action-description">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã</div>
            </button>

            <button type="button" class="action-card" onclick="showWeekReport()">
                <div class="action-icon">üìà</div>
                <div class="action-title">–û—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                <div class="action-description">–°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
            </button>

            <button type="button" class="action-card" onclick="showMonthReport()">
                <div class="action-icon">üìÖ</div>
                <div class="action-title">–û—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü</div>
                <div class="action-description">–°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
            </button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤ -->
    <div class="reports-list-section">
        <div class="section-header">
            <h2 class="section-title">–°–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤</h2>
            <button type="button" class="btn btn-secondary btn-small" onclick="refreshReportsList()">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>

        <div class="table-container">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th data-sort="period" class="sortable sort-desc">
                            <span class="th-content">–ü–µ—Ä–∏–æ–¥</span>
                        </th>
                        <th>
                            <span class="th-content">–°—Ç–∞—Ç—É—Å</span>
                        </th>
                        <th data-sort="created" class="sortable sort-desc">
                            <span class="th-content">–°–æ–∑–¥–∞–Ω</span>
                        </th>
                        <th>
                            <span class="th-content">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                        </th>
                        <th class="actions-header">
                            <span class="th-content">–î–µ–π—Å—Ç–≤–∏—è</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                <tr th:each="report : ${reports}" class="report-row"
                    th:data-report-id="${report.id}"
                    th:data-report-status="${report.status}">

                    <td class="period-cell">
                        <div class="period-dates" th:text="${#strings.concat(report.periodStart, ' - ', report.periodEnd)}">
                            01.01.2024 - 31.01.2024
                        </div>
                    </td>

                    <td>
                        <div class="status-badge"
                                th:classappend="${report.status == 'COMPLETED'} ? 'status-completed' :
                                  (${report.status == 'PROCESSING'} ? 'status-processing' :
                                   (${report.status == 'ERROR'} ? 'status-error' : 'status-created'))">
                            <span th:switch="${report.status}">
                                <span th:case="COMPLETED">–ó–∞–≤–µ—Ä—à—ë–Ω</span>
                                <span th:case="PROCESSING">–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è</span>
                                <span th:case="ERROR">–û—à–∏–±–∫–∞</span>
                                <span th:case="CREATED">–°–æ–∑–¥–∞–Ω</span>
                            </span>
                        </div>
                    </td>

                    <td>
                        <div class="date-time">
                            <div th:text="${#strings.substring(report.createdAt, 0, 10)}">2024.01.01</div>
                            <div th:text="${#strings.substring(report.createdAt, 11, 19)}"
                                 class="time-text">14:30:22</div>
                        </div>
                    </td>

                    <td>
                        <div th:if="${report.totalExecutionTime != null}" class="execution-time">
                            <div th:text="${report.totalExecutionTime} + ' –º—Å'">1250 –º—Å</div>
                            <div class="time-text" th:text="${#numbers.formatDecimal(report.totalExecutionTime / 1000.0, 1, 2)} + ' —Å'">1.25 —Å</div>
                        </div>
                        <div th:unless="${report.totalExecutionTime != null}" class="execution-time">
                            -
                        </div>
                    </td>

                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon" th:onclick="'viewReport(' + ${report.id} + ')'"
                                    title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xIDEyczQtNyAxMS03IDExIDcgMTEgN20tMTEtN2ExIDEgMCAxIDAtMiAwIDEgMSAwIDAgMCAyIDB6Ij48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyI+PC9jaXJjbGU+PC9zdmc+"
                                     alt="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å" width="16" height="16">
                            </button>
                            <button class="btn-icon" th:if="${report.status == 'COMPLETED'}"
                                    th:onclick="'downloadReport(' + ${report.id} + ')'"
                                    title="–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMSAxNXY0YTIgMiAwIDAgMS0yIDJINWEyIDIgMCAwIDEtMi0ydi00Ij48L3BhdGg+PHBvbHlsaW5lIHBvaW50cz0iNyAxMCAxMiAxNSAxNyAxMCI+PC9wb2x5bGluZT48bGluZSB4MT0iMTIiIHkxPSIxNSIgeDI9IjEyIiB5Mj0iMyI+PC9saW5lPjwvc3ZnPg=="
                                     alt="–°–∫–∞—á–∞—Ç—å" width="16" height="16">
                            </button>
                            <button class="btn-icon" th:if="${report.status == 'ERROR' || report.status == 'CREATED'}"
                                    th:onclick="'retryReport(' + ${report.id} + ')'"
                                    title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ">
                                <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${reports.isEmpty()}" class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3 class="empty-state-title">–û—Ç—á—ë—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p class="empty-state-description">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤.</p>
            <button type="button" class="btn btn-primary" onclick="createReport()">
                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç—á—ë—Ç
            </button>
        </div>

        <div class="reports-stats">
            <div class="stats-item">
                <span class="stats-label">–í—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤:</span>
                <span class="stats-value" th:text="${totalElements}">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</span>
                <span class="stats-value" id="completedCount">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è:</span>
                <span class="stats-value" id="processingCount">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">–°—Ç—Ä–∞–Ω–∏—Ü–∞:</span>
                <span class="stats-value" th:text="${currentPage + 1} + '/' + ${totalPages}">1/1</span>
            </div>
            <div class="stats-item">
                <span class="stats-label"><label for="pageSizeSelect">–û—Ç—á—ë—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label></span>
                <span class="stats-value"> <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize(this.value)">
                    <option value="8" th:selected="${pageSize == 8}">8</option>
                    <option value="16" th:selected="${pageSize == 16}">16</option>
                    <option value="32" th:selected="${pageSize == 32}">32</option>
                    <option value="48" th:selected="${pageSize == 48}">48</option>
                </select></span>
            </div>
        </div>
    </div>
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination-section" th:if="${totalPages > 1}">
        <div class="pagination-controls">

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º -->
            <div class="pagination-nav">
                <button class="pagination-btn" th:disabled="${!(currentPage > 0)}"
                        onclick="goToPreviousPage()" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                    ‚Üê
                </button>

                <div class="pagination-pages">
                    <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                    <button class="pagination-page" th:classappend="${currentPage == 0} ? 'active' : ''"
                            onclick="goToPage(0)" th:text="1">1</button>

                    <span th:if="${!((currentPage == 0) || (currentPage == (totalPages - 1)))}" class="pagination-page active" th:text="${currentPage + 1}"> 1 </span>

                    <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                    <button class="pagination-page" th:classappend="${currentPage == (totalPages - 1)} ? 'active' : ''"
                            th:text="${totalPages}"
                            th:onclick="'goToPage(' + (${totalPages} - 1) + ')'"></button>
                </div>

                <button class="pagination-btn" th:disabled="${!(currentPage < (totalPages - 1))}"
                        onclick="goToNextPage()" title="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                    ‚Üí
                </button>
            </div>

            <div class="pagination-info">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${currentPage + 1}">1</span> –∏–∑
                <span th:text="${totalPages}">1</span>
                (–≤—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤: <span th:text="${totalElements}">0</span>)
            </div>
        </div>
    </div>
</main>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á—ë—Ç–∞ -->
<div id="reportViewModal" class="modal-overlay">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3 class="modal-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞</h3>
            <div class="modal-header-actions">
                <button type="button" class="btn btn-secondary btn-small" onclick="refreshReportContent()" title="–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç">
                    <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </button>
                <button type="button" class="btn-close" onclick="closeReportModal()">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="report-header" id="reportHeader">
                <div class="report-period">
                    <span class="period-label">–ü–µ—Ä–∏–æ–¥:</span>
                    <span class="period-value" id="reportPeriod">-</span>
                </div>
                <div class="report-status">
                    <span class="status-label">–°—Ç–∞—Ç—É—Å:</span>
                    <div class="status-badge" id="reportStatusBadge">-</div>
                </div>
                <div class="report-time">
                    <span class="time-label">–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                    <span class="time-value" id="reportExecutionTime">-</span>
                </div>
            </div>

            <div class="report-content-container">
                <div class="loading-overlay" id="reportLoading">
                    <div class="loading-spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞...</div>
                </div>
                <div id="reportContent" class="report-content"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeReportModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" class="btn btn-primary" onclick="downloadCurrentReport()" id="downloadReportBtn">
                –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
            </button>
        </div>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notificationsContainer"></div>

<script th:src="@{/js/reports.js}"></script>
</body>
</html>