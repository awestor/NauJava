<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/account.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="main-container">
  <div class="profile-layout">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="left-column">
      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
      <div class="calendar-section">
        <div class="calendar" id="calendar">
          <div class="calendar-loading">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-section">
          <div class="streak-card">
            <div class="streak-icon">üî•</div>
            <div class="streak-info">
              <div class="streak-count" th:text="${userProfile.currentStreak} + ' –¥–Ω–µ–π'">0 –¥–Ω–µ–π</div>
              <div class="streak-label">–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</div>
            </div>
          </div>
        </div>
      </div>

      <!-- –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
      <div class="goals-section">
        <h3 class="section-title">–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
        <div class="goals-table" th:if="${hasCompleteProfile}">
          <div class="goal-row">
            <span class="goal-label">–ö–∞–ª–æ—Ä–∏–∏:</span>
            <span class="goal-value" th:text="${nutritionGoal.dailyCalorieGoal} + ' –∫–∫–∞–ª'">2000 –∫–∫–∞–ª</span>
          </div>
          <div class="goal-row" th:if="${nutritionGoal.dailyProteinGoal}">
            <span class="goal-label">–ë–µ–ª–∫–∏:</span>
            <span class="goal-value" th:text="${nutritionGoal.dailyProteinGoal} + ' –≥'">150 –≥</span>
          </div>
          <div class="goal-row" th:if="${nutritionGoal.dailyFatGoal}">
            <span class="goal-label">–ñ–∏—Ä—ã:</span>
            <span class="goal-value" th:text="${nutritionGoal.dailyFatGoal} + ' –≥'">70 –≥</span>
          </div>
          <div class="goal-row" th:if="${nutritionGoal.dailyCarbsGoal}">
            <span class="goal-label">–£–≥–ª–µ–≤–æ–¥—ã:</span>
            <span class="goal-value" th:text="${nutritionGoal.dailyCarbsGoal} + ' –≥'">250 –≥</span>
          </div>
        </div>
        <div class="goals-warning" th:unless="${hasCompleteProfile}">
          <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</p>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="right-column">
      <div class="tabs-section">
        <div class="tabs-header">
          <button class="tab-button active" data-tab="account">–ê–∫–∫–∞—É–Ω—Ç</button>
          <button class="tab-button" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <div class="tab-content active" id="accountTab">
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">–õ–æ–≥–∏–Ω:</span>
              <span class="info-value" th:text="${user.login}">user123</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value" th:text="${user.email}">user@example.com</span>
            </div>
            <button class="btn btn-outline edit-btn" onclick="openEditAccountModal()">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
          </div>
        </div>

        <div class="tab-content" id="profileTab">
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">–ò–º—è:</span>
              <span class="info-value" th:text="${userProfile.name} ?: '-'">–ò–≤–∞–Ω</span>
            </div>
              <div class="info-row">
                  <span class="info-label">–§–∞–º–∏–ª–∏—è:</span>
                  <span class="info-value" th:text="${userProfile.surname} ?: '-'">–ò–≤–∞–Ω–æ–≤</span>
              </div>
              <div class="info-row">
                  <span class="info-label">–û—Ç—á–µ—Å—Ç–≤–æ:</span>
                  <span class="info-value" th:text="${userProfile.patronymic} ?: '-'">-</span>
              </div>
            <div class="info-row" th:if="${date}">
              <span class="info-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</span>
                <span class="info-value" th:if="${date != null}"
                      th:text="${#dates.format(date, 'dd.MM.yyyy')}">01.01.1990</span>
                <span class="info-value" th:unless="${date != null}">--.--.----</span>
            </div>
              <div class="info-row">
                  <span class="info-label">–ü–æ–ª:</span>
                  <span class="info-value" th:if="${userProfile.gender != null && userProfile.gender == 'M'}">–ú—É–∂—Å–∫–æ–π</span>
                  <span class="info-value" th:if="${userProfile.gender != null && userProfile.gender == 'F'}">–ñ–µ–Ω—Å–∫–∏–π</span>
                  <span class="info-value" th:unless="${userProfile.gender != null}">-</span>
              </div>
              <div class="info-row">
                  <span class="info-label">–†–æ—Å—Ç:</span>
                  <span class="info-value" th:if="${userProfile.height != null}"
                        th:text="${userProfile.height} + ' —Å–º'">180 —Å–º</span>
                  <span class="info-value" th:unless="${userProfile.height != null}">-</span>
              </div>
              <div class="info-row">
                  <span class="info-label">–í–µ—Å:</span>
                  <span class="info-value" th:if="${userProfile.weight != null}"
                        th:text="${userProfile.weight} + ' –∫–≥'">75 –∫–≥</span>
                  <span class="info-value" th:unless="${userProfile.weight != null}">-</span>
              </div>
              <div class="info-row">
                  <span class="info-label">–¶–µ–ª–µ–≤–æ–π –≤–µ—Å:</span>
                  <span class="info-value" th:if="${userProfile.targetWeight != null}"
                        th:text="${userProfile.targetWeight} + ' –∫–≥'">70 –∫–≥</span>
                  <span class="info-value" th:unless="${userProfile.targetWeight != null}">-</span>
              </div>
              <div class="info-row">
                  <span class="info-label">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</span>
                  <span class="info-value" th:if="${userProfile.activityLevel != null}"
                        th:text="${userProfile.activityLevel.levelName}">–£–º–µ—Ä–µ–Ω–Ω–∞—è</span>
                  <span class="info-value" th:unless="${userProfile.activityLevel != null}">-</span>
              </div>
              <button class="btn btn-outline edit-btn" onclick="openEditProfileModal()">
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
<div id="accountModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
      <button type="button" class="btn-close" onclick="closeAccountModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="accountForm">
        <div class="form-group">
          <label for="login" class="form-label">–õ–æ–≥–∏–Ω</label>
          <input type="text" id="login" name="login" class="form-input"
                 th:value="${user.login}" required>
          <div class="error-message" id="loginError"></div>
          <div class="form-hint">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è</div>
        </div>
        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" name="email" class="form-input"
                 th:value="${user.email}" required>
          <div class="error-message" id="emailError"></div>
        </div>
        <div class="form-group">
          <label for="password" class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
          <input type="password" id="password" name="password" class="form-input">
          <div class="error-message" id="passwordError"></div>
          <div class="form-hint">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã</div>
        </div>
        <div class="form-group">
          <label for="confirmPassword" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
          <input type="password" id="confirmPassword" name="confirmPassword" class="form-input">
          <div class="error-message" id="confirmPasswordError"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAccountModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary" id="accountSubmitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
<div id="profileModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
      <button type="button" class="btn-close" onclick="closeProfileModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="profileForm">
        <div class="form-row">
          <div class="form-group">
            <label for="name" class="form-label">–ò–º—è</label>
            <input type="text" id="name" name="name" class="form-input"
                   th:value="${userProfile.name}" required>
            <div class="error-message" id="nameError"></div>
          </div>
          <div class="form-group">
            <label for="surname" class="form-label">–§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="surname" name="surname" class="form-input"
                   th:value="${userProfile.surname}" required>
            <div class="error-message" id="surnameError"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="patronymic" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
          <input type="text" id="patronymic" name="patronymic" class="form-input"
                 th:value="${userProfile.patronymic}">
          <div class="error-message" id="patronymicError"></div>
        </div>
        <div class="form-group">
          <label for="dateOfBirth" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-input"
                 th:value="${userProfile.dateOfBirth}">
          <div class="error-message" id="dateOfBirthError"></div>
        </div>
        <div class="form-group">
          <label for="gender" class="form-label">–ü–æ–ª</label>
          <select id="gender" name="gender" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</option>
            <option value="M" th:selected="${userProfile.gender == 'M'}">–ú—É–∂—Å–∫–æ–π</option>
            <option value="F" th:selected="${userProfile.gender == 'F'}">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
          <div class="error-message" id="genderError"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="height" class="form-label">–†–æ—Å—Ç (—Å–º)</label>
            <input type="number" id="height" name="height" class="form-input"
                   th:value="${userProfile.height}" min="100" max="250">
            <div class="error-message" id="heightError"></div>
          </div>
          <div class="form-group">
            <label for="weight" class="form-label">–í–µ—Å (–∫–≥)</label>
            <input type="number" id="weight" name="weight" class="form-input"
                   th:value="${userProfile.weight}" min="30" max="300" step="0.1">
            <div class="error-message" id="weightError"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="targetWeight" class="form-label">–¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)</label>
          <input type="number" id="targetWeight" name="targetWeight" class="form-input"
                 th:value="${userProfile.targetWeight}" min="30" max="300" step="0.1">
          <div class="error-message" id="targetWeightError"></div>
        </div>
        <div class="form-group">
          <label for="activityLevel" class="form-label">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
          <select id="activityLevel" name="activityLevelId" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
            <option th:each="level : ${activityLevels}"
                    th:value="${level.id}"
                    th:text="${level.levelName}"
                    th:selected="${userProfile.activityLevel != null && userProfile.activityLevel.id == level.id}">
            </option>
          </select>
          <div class="error-message" id="activityLevelError"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary" id="profileSubmitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    let originalAccountData = null;
    let originalProfileData = null;
    let isSubmitting = false;

    document.addEventListener('DOMContentLoaded', function() {
        initializeCalendar();
        initializeTabs();
        storeOriginalData();
    });

    function storeOriginalData() {
      originalAccountData = {
        login: document.getElementById('login')?.value || '',
        email: document.getElementById('email')?.value || ''
      };

      const dateOfBirthInput = document.getElementById('dateOfBirth');
      const heightInput = document.getElementById('height');
      const weightInput = document.getElementById('weight');
      const targetWeightInput = document.getElementById('targetWeight');
      const activityLevelInput = document.getElementById('activityLevel');

      originalProfileData = {
        name: document.getElementById('name')?.value || '',
        surname: document.getElementById('surname')?.value || '',
        patronymic: document.getElementById('patronymic')?.value || '',
        dateOfBirth: dateOfBirthInput?.value || '',
        gender: document.getElementById('gender')?.value || '',
        height: heightInput?.value || '',
        weight: weightInput?.value || '',
        targetWeight: targetWeightInput?.value || '',
        activityLevelId: activityLevelInput?.value || ''
      };
    }

    function hasAccountChanges() {
        if (!originalAccountData) return true;

        const currentData = {
            login: document.getElementById('login').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };

        return currentData.login !== originalAccountData.login ||
               currentData.email !== originalAccountData.email ||
               currentData.password !== '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
    function hasProfileChanges() {
      if (!originalProfileData) return true;

      const dateOfBirthInput = document.getElementById('dateOfBirth');
      const heightInput = document.getElementById('height');
      const weightInput = document.getElementById('weight');
      const targetWeightInput = document.getElementById('targetWeight');
      const activityLevelInput = document.getElementById('activityLevel');

      const currentData = {
          name: document.getElementById('name').value,
          surname: document.getElementById('surname').value,
          patronymic: document.getElementById('patronymic').value,
          dateOfBirth: dateOfBirthInput?.value || '',
          gender: document.getElementById('gender').value,
          height: heightInput?.value || '',
          weight: weightInput?.value || '',
          targetWeight: targetWeightInput?.value || '',
          activityLevelId: activityLevelInput?.value || ''
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Å —É—á–µ—Ç–æ–º null
      const valuesEqual = (val1, val2) => {
          const normalizedVal1 = val1 === '' ? null : val1;
          const normalizedVal2 = val2 === '' ? null : val2;
          return normalizedVal1 === normalizedVal2;
      };

      return !valuesEqual(currentData.name, originalProfileData.name) ||
             !valuesEqual(currentData.surname, originalProfileData.surname) ||
             !valuesEqual(currentData.patronymic, originalProfileData.patronymic) ||
             !valuesEqual(currentData.dateOfBirth, originalProfileData.dateOfBirth) ||
             !valuesEqual(currentData.gender, originalProfileData.gender) ||
             !valuesEqual(currentData.height, originalProfileData.height) ||
             !valuesEqual(currentData.weight, originalProfileData.weight) ||
             !valuesEqual(currentData.targetWeight, originalProfileData.targetWeight) ||
             !valuesEqual(currentData.activityLevelId, originalProfileData.activityLevelId);
    }

    function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');

                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function openEditAccountModal() {
        clearErrors('accountForm');
        document.getElementById('accountModal').classList.add('active');
    }

    function closeAccountModal() {
        document.getElementById('accountModal').classList.remove('active');
    }

    function openEditProfileModal() {
      clearErrors('profileForm');
      initializeProfileForm();
      document.getElementById('profileModal').classList.add('active');
    }

    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('active');
    }

    // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
    function clearErrors(formId) {
        const form = document.getElementById(formId);
        const errorMessages = form.querySelectorAll('.error-message');
        errorMessages.forEach(error => error.textContent = '');
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    function validatePassword(password) {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!$%^()_+\-=\[\]{};:'",.<>])[A-Za-z\d!$%^()_+\-=\[\]{};:'",.<>]{8,}$/;
        return regex.test(password);
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
    function validateLogin(login) {
        const regex = /^[a-zA-Z0-9_]+$/;
        return login.length >= 6 && regex.test(login);
    }

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    function setSubmittingState(isSubmitting) {
        window.isSubmitting = isSubmitting;
    }

    document.getElementById('accountForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (isSubmitting) {
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π', 'info');
            return;
        }

        if (!hasAccountChanges()) {
            showNotification('–î–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã', 'info');
            closeAccountModal();
            return;
        }

        clearErrors('accountForm');

        const formData = new FormData(this);
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        const login = formData.get('login');
        const email = formData.get('email');

        let isValid = true;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
        if (!validateLogin(login)) {
            document.getElementById('loginError').textContent = '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)';
            isValid = false;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        if (!email) {
            document.getElementById('emailError').textContent = 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
            isValid = false;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
        if (password) {
            if (!validatePassword(password)) {
                document.getElementById('passwordError').textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã';
                isValid = false;
            }

            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                isValid = false;
            }
        }

        if (!isValid) return;

        const data = {
            login: login,
            email: email,
            password: password || null
        };

        const submitBtn = document.getElementById('accountSubmitBtn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        setSubmittingState(true);

        fetch('/api/account/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(async response => {
            console.log('Response status:', response.status);

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ JSON –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const responseData = await response.json();
            if (response.ok) {
                closeAccountModal();
                showNotification('–î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                if (responseData.validationErrors) {
                    responseData.validationErrors.forEach(error => {
                        const errorElement = document.getElementById(error.field + 'Error');
                        if (errorElement) {
                            errorElement.textContent = error.message;
                        }
                    });
                } else if (responseData.message) {
                    showNotification(responseData.message, 'error');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞', 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            setTimeout(() => setSubmittingState(false), 1000);
        });
    });

    document.getElementById('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();

      if (isSubmitting) {
          showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π', 'info');
          return;
      }

      if (!hasProfileChanges()) {
          showNotification('–î–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã', 'info');
          closeProfileModal();
          return;
      }

      clearErrors('profileForm');

      const formData = new FormData(this);

      const parseFormValue = (value) => {
          if (value === '' || value === null || value === undefined) {
              return null;
          }
          return value;
      };

      const parseNumberValue = (value) => {
          if (value === '' || value === null || value === undefined) {
              return null;
          }
          return parseFloat(value);
      };

      const parseIntValue = (value) => {
          if (value === '' || value === null || value === undefined) {
              return null;
          }
          return parseInt(value);
      };

      const data = {
          name: parseFormValue(formData.get('name')),
          surname: parseFormValue(formData.get('surname')),
          patronymic: parseFormValue(formData.get('patronymic')),
          dateOfBirth: parseFormValue(formData.get('dateOfBirth')),
          gender: parseFormValue(formData.get('gender')),
          height: parseIntValue(formData.get('height')),
          weight: parseNumberValue(formData.get('weight')),
          targetWeight: parseNumberValue(formData.get('targetWeight')),
          activityLevelId: parseIntValue(formData.get('activityLevelId'))
      };

      const submitBtn = document.getElementById('profileSubmitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      setSubmittingState(true);

      fetch('/api/profile/update', {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRF-TOKEN': getCsrfToken()
          },
          body: JSON.stringify(data)
      })
      .then(async response => {
          console.log('Response status:', response.status);

          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
              throw new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ JSON –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
          }
          const responseData = await response.json();

          if (response.ok) {
              closeProfileModal();
              showNotification('–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
              setTimeout(() => location.reload(), 1000);
          } else {
              if (responseData.validationErrors) {
                  responseData.validationErrors.forEach(error => {
                      const errorElement = document.getElementById(error.field + 'Error');
                      if (errorElement) {
                          errorElement.textContent = error.message;
                      }
                  });
              } else if (responseData.message) {
                  showNotification(responseData.message, 'error');
              } else {
                  showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è', 'error');
              }
          }
      })
      .catch(error => {
          console.error('Error:', error);
          showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è', 'error');
      })
      .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          setTimeout(() => setSubmittingState(false), 1000);
      });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCsrfToken() {
        const metaToken = document.querySelector('meta[name="_csrf"]');
        return metaToken ? metaToken.getAttribute('content') : '';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;

        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

        if (type === 'success') {
            notification.style.background = '#2ea043';
        } else if (type === 'error') {
            notification.style.background = '#cf222e';
        } else if (type === 'info') {
            notification.style.background = '#0969da';
        } else {
            notification.style.background = '#656d76';
        }

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        calendarEl.innerHTML = `
            <div class="calendar-loading">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
            </div>
        `;

        loadCalendarData();
    }

    async function loadCalendarData() {
        try {
            const response = await fetch('/api/daily-reports/calendar', {
                headers: {
                    'X-CSRF-TOKEN': getCsrfToken()
                }
            });

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
            }

            const calendarData = await response.json();
            renderCalendar(calendarData);
        } catch (error) {
            console.error('Error loading calendar data:', error);
            showCalendarError();
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function renderCalendar(calendarData) {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();

        // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();

        let calendarHTML = '<div class="calendar-header">';
        calendarHTML += '<div class="calendar-month">' +
                        today.toLocaleString('ru-RU', { month: 'long', year: 'numeric' }) +
                        '</div>';
        calendarHTML += '</div>';
        calendarHTML += '<div class="calendar-grid">';

        const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        weekdays.forEach(day => {
            calendarHTML += `<div class="calendar-weekday">${day}</div>`;
        });

        for (let i = 0; i < (startingDay === 0 ? 6 : startingDay - 1); i++) {
            calendarHTML += '<div class="calendar-day empty"></div>';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);

            const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            const dateString = localDate.toISOString().split('T')[0]; // –§–æ—Ä–º–∞—Ç YYYY-MM-DD

            const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dateWithoutTime = new Date(year, month, day);

            const isToday = dateWithoutTime.getTime() === todayWithoutTime.getTime();
            const isPast = dateWithoutTime < todayWithoutTime;
            const isFuture = dateWithoutTime > todayWithoutTime;

            const dayData = calendarData.find(d => d.date === dateString);
            const isGoalAchieved = dayData ? dayData.isGoalAchieved : false;

            let dayClass = 'calendar-day';
            if (isToday) dayClass += ' today';
            if (isPast) {
                dayClass += isGoalAchieved ? ' achieved' : ' not-achieved';
            } else if (isFuture) {
                dayClass += ' future';
            }

            calendarHTML += `<div class="${dayClass}" title="${dateString}: ${isGoalAchieved ? '–ü—Ä–∏—ë–º –ø–∏—â–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –Ω–µ –±—ã–ª–æ'}">${day}</div>`;
        }

        calendarHTML += '</div>';

        // –õ–µ–≥–µ–Ω–¥–∞
        calendarHTML += `
            <div class="calendar-legend">
                <div class="legend-item">
                    <span class="legend-color achieved"></span>
                    <span>–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color not-achieved"></span>
                    <span>–¶–µ–ª—å –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color future"></span>
                    <span>–ë—É–¥—É—â–∏–µ –¥–Ω–∏</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color today"></span>
                    <span>–°–µ–≥–æ–¥–Ω—è</span>
                </div>
            </div>
        `;

        calendarEl.innerHTML = calendarHTML;
    }

    function initializeProfileForm() {
      const inputs = {
          dateOfBirth: document.getElementById('dateOfBirth'),
          height: document.getElementById('height'),
          weight: document.getElementById('weight'),
          targetWeight: document.getElementById('targetWeight'),
          activityLevel: document.getElementById('activityLevel')
      };

      Object.keys(inputs).forEach(key => {
          const input = inputs[key];
          if (input && !input.value) {
              if (key === 'dateOfBirth') {
                  input.placeholder = '–¥–¥.–º–º.–≥–≥–≥–≥';
              } else if (key === 'activityLevel') {
              } else {
                  input.placeholder = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
              }
          }
      });
    }

    function showCalendarError() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        calendarEl.innerHTML = `
            <div class="calendar-error">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</p>
                <button class="btn btn-outline" onclick="initializeCalendar()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
        `;
    }
</script>
</body>
</html>