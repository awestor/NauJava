<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/meals.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
</head>
<body>
<!-- –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="main-container">
  <div class="page-header">
    <h1 class="page-title">–ú–æ–∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h1>
    <button class="btn btn-primary" onclick="createNewMeal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
    </button>
  </div>

  <div class="date-section">
    <label for="datePicker" class="date-label">–î–∞—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</label>
    <input type="date" id="datePicker" class="date-input"
           th:value="${#dates.format(currentDate, 'yyyy-MM-dd')}"
           onchange="updateDate(this.value)">
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ -->
  <div id="mealsContainer">
    <div th:each="meal : ${meals}" class="meal-section">
      <div class="meal-header">
        <h3 class="meal-title" th:text="${meal.mealType}">–ó–∞–≤—Ç—Ä–∞–∫</h3>
        <div class="action-buttons" th:if="${isToday}">
          <button class="btn-icon" th:onclick="'editMeal(' + ${meal.id} + ')'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xMSA0SDRhMiAyIDAgMCAwLTIgMnYxNGEyIDIgMCAwIDAgMiAyaDE0YTIgMiAwIDAgMCAyLTJ2LTciPjwvcGF0aD48cGF0aCBkPSJNMTguNSAyLjVhMi4xMjEgMi4xMjEgMCAwIDEgMyAzTDEyIDE1bC00IDEgMS00IDkuNS05LjV6Ij48L3BhdGg+PC9zdmc+"
                 alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" width="16" height="16">
          </button>
          <button class="btn-icon" th:onclick="'deleteMeal(' + ${meal.id} + ')'"title="–£–¥–∞–ª–∏—Ç—å">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwb2x5bGluZSBwb2ludHM9IjMgNiA1IDYgMjEgNiI+PC9wb2x5bGluZT48cGF0aCBkPSJNMTkgNnYxNGEyIDIgMCAwIDEtMiAySDdhMiAyIDAgMCAxLTItMlY2bTMgMFY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiPjwvcGF0aD48L3N2Zz4="
                 alt="–£–¥–∞–ª–∏—Ç—å" width="16" height="16">
          </button>
        </div>
      </div>

      <div class="meal-content">
        <table class="nutrition-table">
          <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</th>
            <th class="text-right">–ö–∞–ª–æ—Ä–∏–∏</th>
            <th class="text-right">–ü—Ä–æ—Ç–µ–∏–Ω—ã</th>
            <th class="text-right">–ñ–∏—Ä—ã</th>
            <th class="text-right">–£–≥–ª–µ–≤–æ–¥—ã</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="entry : ${mealEntries.get(meal.id)}">
            <td th:text="${entry.product.name}">–Ø–±–ª–æ–∫–æ</td>
            <td class="text-right font-mono" th:text="${entry.calculatedCalories}">52</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedProteins, 1, 2)}">0.3</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedFats, 1, 2)}">0.2</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedCarbs, 1, 2)}">14</td>
          </tr>
          </tbody>
          <tfoot>
            <tr>
              <td><strong>–°—É–º–º–∞—Ä–Ω–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</strong></td>
              <td class="text-right font-mono text-success"
                  th:text="${nutritionSums.get(meal.id)?.totalCalories ?: 0}">0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalProteins ?: 0, 1, 2)}">0.0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalFats ?: 0, 1, 2)}">0.0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalCarbs ?: 0, 1, 2)}">0.0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div th:if="${meals.isEmpty()}" class="empty-state">
    <div class="empty-state-icon">üçΩÔ∏è</div>
    <h3 class="empty-state-title">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="empty-state-description">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
    <button class="btn btn-primary" onclick="createNewMeal()" th:if="${isToday}">
      –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏
    </button>
  </div>

  <div id="mealModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</h3>
        <button type="button" class="btn-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="mealForm">
          <input type="hidden" id="mealId" name="id">

          <div class="form-group">
            <label for="mealTypeSelect" class="form-label">–¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</label>
            <select id="mealTypeSelect" class="form-select" name="mealTypeName" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç—ã</label>
            <div id="productsContainer">
              <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <button type="button" id="addProductBtn" class="add-product-btn" onclick="addProductRow()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
            </button>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</main>

<script>
  let mealTypes = [];
  let products = [];
  let currentMealData = null;

  function updateDate(date) {
      window.location.href = '/view/meals/list?date=' + date;
  }

  function createNewMeal() {
      openModal('create');
  }

  function editMeal(mealId) {
      openModal('edit', mealId);
  }

  function openModal(mode, mealId = null) {
      const modal = document.getElementById('mealModal');
      const title = document.getElementById('modalTitle');
      const submitBtn = document.getElementById('submitBtn');

      resetForm();
      document.getElementById('mealId').value = '';

      if (mode === 'create') {
          title.textContent = '–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏';
          submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å';
          addProductRow();
      } else {
          title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏';
          submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          document.getElementById('mealId').value = mealId;
          loadMealData(mealId);
      }

      let mouseDownOnOverlay = false;

        modal.addEventListener('mousedown', function(e) {
            if (e.target === this) {
                mouseDownOnOverlay = true;
            }
        });

        modal.addEventListener('mouseup', function(e) {
            if (e.target === this && mouseDownOnOverlay) {
                closeModal();
            }
            mouseDownOnOverlay = false;
        });

      loadFormData();
      modal.classList.add('active');
  }

  function closeModal() {
      const modal = document.getElementById('mealModal');
      modal.classList.remove('active');
      resetForm();
  }

  function resetForm() {
      document.getElementById('productsContainer').innerHTML = '';
      document.getElementById('mealTypeSelect').value = '';
      updateAddButtonState();
      hideEmptyMessage();
  }

  function loadMealData(mealId) {
      fetch(`/api/meals/${mealId}`, {
          headers: {
              'X-CSRF-TOKEN': getCsrfToken()
          }
      })
          .then(response => {
              if (!response.ok) {
                  throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
              }
              return response.json();
          })
          .then(meal => {
              currentMealData = meal;
              populateMealForm(meal);
          })
          .catch(error => {
              console.error('Error loading meal data:', error);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
          });
  }

  function populateMealForm(meal) {
    document.getElementById('mealTypeSelect').value = meal.mealType;

    const container = document.getElementById('productsContainer');
    container.innerHTML = '';

    if (meal.mealEntries && meal.mealEntries.length > 0) {
        meal.mealEntries.forEach(entry => {
            addProductRow(entry.productName, entry.quantityGrams);
        });
    } else {
        addProductRow();
    }

    updateAddButtonState();
  }

  function loadFormData() {
      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
      if (mealTypes.length === 0) {
          fetch('/api/meal-types', {
              headers: {
                  'X-CSRF-TOKEN': getCsrfToken()
              }
          })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏');
                  }
                  return response.json();
              })
              .then(data => {
                  mealTypes = data;
                  populateMealTypes();
              })
              .catch(error => {
                  console.error('Error loading meal types:', error);
              });
      } else {
          populateMealTypes();
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      if (products.length === 0) {
          fetch('/api/products/all', {
              headers: {
                  'X-CSRF-TOKEN': getCsrfToken()
              }
          })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
                  }
                  return response.json();
              })
              .then(data => {
                  products = data;
                  populateProducts();
              })
              .catch(error => {
                  console.error('Error loading products:', error);
              });
      } else {
          populateProducts();
      }
  }

  function populateMealTypes() {
      const select = document.getElementById('mealTypeSelect');
      const currentValue = select.value;
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</option>';

      mealTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.name;
          option.textContent = type.name;
          select.appendChild(option);
      });

      if (currentValue) {
          select.value = currentValue;
      }
  }

  function populateProducts() {
      const productSelects = document.querySelectorAll('.product-select');
      productSelects.forEach(select => {
          const currentValue = select.value;
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>';

          products.forEach(product => {
              const option = document.createElement('option');
              option.value = product.name;
              option.textContent = product.name;
              option.dataset.productId = product.id;
              select.appendChild(option);
          });

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if (currentValue) {
              select.value = currentValue;
          }
      });
  }

  function addProductRow(productName = '', weight = '') {
      const container = document.getElementById('productsContainer');
      const rowCount = container.children.length;

      if (rowCount >= 8) {
          alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - 8');
          return;
      }

      // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º —Å–ø–∏—Å–∫–µ
      hideEmptyMessage();

      const row = document.createElement('div');
      row.className = 'product-row';
      row.innerHTML = `
          <div class="product-fields">
              <div>
                  <label class="form-label">–í–µ—Å (–≥)</label>
                  <input type="number" class="form-input weight-input"
                         value="${weight}" min="1" max="5000"
                         placeholder="–í–µ—Å" required
                         oninput="validateProductRow(this)">
              </div>
              <div style="flex: 1;">
                  <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç</label>
                  <select class="form-select product-select" required onchange="validateProductRow(this)">
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                  </select>
              </div>
          </div>
          <button type="button" class="remove-product" onclick="removeProductRow(this)" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
          </button>
      `;

      container.appendChild(row);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
      const productSelect = row.querySelector('.product-select');
      if (products && products.length > 0) {
          products.forEach(product => {
              const option = document.createElement('option');
              option.value = product.name;
              option.textContent = product.name;
              option.dataset.productId = product.id;
              productSelect.appendChild(option);
          });
      }

      if (productName) {
          productSelect.value = productName;
      }

      updateAddButtonState();

      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —É –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è
      const allRows = container.querySelectorAll('.product-row');
      if (allRows.length === 1) {
          allRows[0].querySelector('.remove-product').style.visibility = 'hidden';
      } else {
          allRows.forEach(row => {
              row.querySelector('.remove-product').style.visibility = 'visible';
          });
      }
  }

  function validateProductRow(element) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
      const hasValidRows = checkForValidRows();

      if (!hasValidRows) {
          showEmptyMessage();
      } else {
          hideEmptyMessage();
      }
  }

  function checkForValidRows() {
      const productRows = document.querySelectorAll('.product-row');
      for (let row of productRows) {
          const weightInput = row.querySelector('.weight-input');
          const productSelect = row.querySelector('.product-select');

          if (weightInput && productSelect &&
              weightInput.value && productSelect.value) {
              return true;
          }
      }
      return false;
  }

  function showEmptyMessage() {
      const container = document.getElementById('productsContainer');
      const existingMessage = container.querySelector('.empty-products-message');
      if (!existingMessage && container.children.length === 0) {
          container.innerHTML = '<div class="empty-products-message">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç</div>';
      }
  }

  function hideEmptyMessage() {
      const container = document.getElementById('productsContainer');
      const emptyMessage = container.querySelector('.empty-products-message');
      if (emptyMessage) {
          emptyMessage.remove();
      }
  }

  function removeProductRow(button) {
      const container = document.getElementById('productsContainer');
      const rows = container.querySelectorAll('.product-row');

      // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É
      if (rows.length <= 1) {
          alert('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º');
          return;
      }

      const row = button.closest('.product-row');
      row.remove();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
      const hasValidRows = checkForValidRows();
      if (!hasValidRows) {
          showEmptyMessage();
      }

      updateAddButtonState();

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
      const remainingRows = container.querySelectorAll('.product-row');
      if (remainingRows.length === 1) {
          remainingRows[0].querySelector('.remove-product').style.visibility = 'hidden';
      }
  }

  function updateAddButtonState() {
      const container = document.getElementById('productsContainer');
      const addButton = document.getElementById('addProductBtn');
      const rowCount = container.querySelectorAll('.product-row').length;

      addButton.disabled = rowCount >= 8;
  }

  function deleteMeal(mealId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–∏—ë–º –ø–∏—â–∏?')) {
        fetch('/api/meals/' + mealId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            }
        })
        .then(response => {
            if (response.ok) {
                // –£—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                location.reload();
            } else if (response.status === 404) {
                alert('–ü—Ä–∏—ë–º –ø–∏—â–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            } else if (response.status === 403) {
                alert('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
        });
    }
}

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
  document.getElementById('mealForm').addEventListener('submit', function(e) {
      e.preventDefault();

    const mealId = document.getElementById('mealId').value;
    const mealTypeName = document.getElementById('mealTypeSelect').value;
    const productRows = document.querySelectorAll('.product-row');

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
    const productNames = [];
    const quantities = [];
    let isValid = true;

    productRows.forEach(row => {
        const weightInput = row.querySelector('.weight-input');
        const productSelect = row.querySelector('.product-select');

        if (weightInput.value && productSelect.value) {
            productNames.push(productSelect.value);
            quantities.push(parseInt(weightInput.value));
        } else if (weightInput.value || productSelect.value) {
            isValid = false;
            if (!weightInput.value) weightInput.style.borderColor = '#cf222e';
            if (!productSelect.value) productSelect.style.borderColor = '#cf222e';
        }
    });

    if (!isValid) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
        return;
    }

    if (productNames.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç');
        return;
    }

    if (!mealTypeName) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
        return;
    }

    const isEdit = !!mealId;
    let payload, url, method;

    if (isEdit) {
        // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º UpdateMealRequest
        payload = {
            id: parseInt(mealId),
            mealTypeName: mealTypeName,
            productNames: productNames,
            quantities: quantities
        };
        url = `/api/meals/update/${mealId}`;
        method = 'PUT';
    } else {
        // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º CreateMealRequest
        payload = {
            mealTypeName: mealTypeName,
            productNames: productNames,
            quantities: quantities
        };
        url = '/api/meals/create';
        method = 'POST';
    }

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ä–º—ã –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': getCsrfToken()
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (response.ok) {
            closeModal();
            location.reload();
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
  });

  // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –ø–æ–ª–µ–π –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
  document.addEventListener('input', function(e) {
      if (e.target.classList.contains('weight-input') || e.target.classList.contains('product-select')) {
          e.target.style.borderColor = '';
      }
  });

  function editMeal(mealId) {
    openModal('edit', mealId);
  }

  function getCsrfToken() {
      // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
      let token = '';

      // –°–ø–æ—Å–æ–± 1: –∏–∑ meta —Ç–µ–≥–∞
      const metaToken = document.querySelector('meta[name="_csrf"]');
      if (metaToken) {
          token = metaToken.getAttribute('content');
      }

      console.log('Retrieved CSRF token:', token ? 'found' : 'not found');
      return token;
  }

  // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
  function getCsrfTokenFromCookie() {
      const name = 'XSRF-TOKEN';
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
          return parts.pop().split(';').shift();
      }
      return '';
  }
</script>
</body>
</html>