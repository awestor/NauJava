<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/meals.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="main-container">
  <div class="page-header">
    <h1 class="page-title">–ú–æ–∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h1>
    <button class="btn btn-primary" onclick="createNewMeal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
    </button>
  </div>

  <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="calendar-section">
    <div class="calendar-controls">
      <button class="btn btn-secondary" id="prevMonth">‚Üê</button>
      <span id="currentMonth" class="month-display"></span>
      <button class="btn btn-secondary" id="nextMonth">‚Üí</button>
    </div>

    <div class="calendar-grid" id="calendarGrid">
      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <div class="selected-date-info">
      –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: <span id="selectedDateDisplay"></span>
    </div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ -->
  <div id="mealsContainer">
    <div th:each="meal : ${meals}" class="meal-section">
      <div class="meal-header">
        <h3 class="meal-title" th:text="${meal.mealType}">–ó–∞–≤—Ç—Ä–∞–∫</h3>
        <div class="action-buttons" th:if="${isToday}">
          <button class="btn-icon" th:onclick="'editMeal(' + ${meal.id} + ')'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xMSA0SDRhMiAyIDAgMCAwLTIgMnYxNGEyIDIgMCAwIDAgMiAyaDE0YTIgMiAwIDAgMCAyLTJ2LTciPjwvcGF0aD48cGF0aCBkPSJNMTguNSAyLjVhMi4xMjEgMi4xMjEgMCAwIDEgMyAzTDEyIDE1bC00IDEgMS00IDkuNS05LjV6Ij48L3BhdGg+PC9zdmc+"
                 alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" width="16" height="16">
          </button>
          <button class="btn-icon" th:onclick="'deleteMeal(' + ${meal.id} + ')'"title="–£–¥–∞–ª–∏—Ç—å">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwb2x5bGluZSBwb2ludHM9IjMgNiA1IDYgMjEgNiI+PC9wb2x5bGluZT48cGF0aCBkPSJNMTkgNnYxNGEyIDIgMCAwIDEtMiAySDdhMiAyIDAgMCAxLTItMlY2bTMgMFY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiPjwvcGF0aD48L3N2Zz4="
                 alt="–£–¥–∞–ª–∏—Ç—å" width="16" height="16">
          </button>
        </div>
      </div>

      <div class="meal-content">
        <table class="nutrition-table">
          <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</th>
            <th class="text-right">–ö–∞–ª–æ—Ä–∏–∏</th>
            <th class="text-right">–ü—Ä–æ—Ç–µ–∏–Ω—ã</th>
            <th class="text-right">–ñ–∏—Ä—ã</th>
            <th class="text-right">–£–≥–ª–µ–≤–æ–¥—ã</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="entry : ${mealEntries.get(meal.id)}">
            <td th:text="${entry.product?.name ?: '–ü—Ä–æ–¥—É–∫—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω'}">–Ø–±–ª–æ–∫–æ</td>
            <td class="text-right font-mono" th:text="${entry.calculatedCalories}">52</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedProteins, 1, 2)}">0.3</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedFats, 1, 2)}">0.2</td>
            <td class="text-right font-mono" th:text="${#numbers.formatDecimal(entry.calculatedCarbs, 1, 2)}">14</td>
          </tr>
          </tbody>
          <tfoot>
            <tr>
              <td><strong>–°—É–º–º–∞—Ä–Ω–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</strong></td>
              <td class="text-right font-mono text-success"
                  th:text="${nutritionSums.get(meal.id)?.totalCalories ?: 0}">0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalProteins ?: 0, 1, 2)}">0.0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalFats ?: 0, 1, 2)}">0.0</td>
              <td class="text-right font-mono"
                  th:text="${#numbers.formatDecimal(nutritionSums.get(meal.id)?.totalCarbs ?: 0, 1, 2)}">0.0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div th:if="${meals.isEmpty()}" class="empty-state">
    <div class="empty-state-icon">üçΩÔ∏è</div>
    <h3 class="empty-state-title">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="empty-state-description">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
    <button class="btn btn-primary" onclick="createNewMeal()" th:if="${isToday}">
      –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏
    </button>
  </div>

  <div id="mealModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</h3>
        <button type="button" class="btn-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="mealForm">
          <input type="hidden" id="mealId" name="id">

          <div class="form-group">
            <label for="mealTypeSelect" class="form-label">–¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</label>
            <select id="mealTypeSelect" class="form-select" name="mealTypeName" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç—ã</label>
            <div id="productsContainer">
              <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <button type="button" id="addProductBtn" class="add-product-btn" onclick="addProductRow()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
            </button>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</main>

<script th:src="@{/js/meals.js}"></script>
</body>
</html>